(function(){function e(){y=[];E=null;H=!1;if(D.length>0){L=new WebSocket("ws://"+D);L.binaryType="arraybuffer";L.onopen=function(e){b=[];null!=E&&(N=E.x);H=!0;console.log("Socket connected")};L.onmessage=function(e){e=e.data;switch((new DataView(e)).getUint8(0)){case 0:x=(new DataView(e)).getInt32(1,!0);E=new s(x,[],"");y.push(E);l();document.getElementById("server").style.display="none";document.getElementById("connect").style.display="none";document.getElementById("nickname").style.display="none";document.getElementById("disconnect").style.display="block";break;case 2:e=new DataView(e);T=e.getUint32(1,!0);for(var t=e.getInt32(5,!0),n=9,r=0;r<t;r++){for(var i=e.getInt32(n,!0),n=n+4,u="";;){var a=e.getUint8(n++);if(0==a)break;u+=String.fromCharCode(a)}for(var a=[],f=e.getUint16(n,!0),n=n+2,c=0;c<f;c++)a.push(e.getUint16(n,!0)),n+=2;i!=x&&(i=new s(i,a,u),A.push(i))}break;case 3:for(e=new DataView(e),t=1,n=e.getInt32(t,!0),t+=4,r=0;r<n;r++){b.push(new o(e.getInt32(t+0,!0),e.getInt32(t+4,!0)));t+=8}}};L.onclose=function(){H=!1;document.getElementById("server").style.display="inline";document.getElementById("connect").style.display="inline";document.getElementById("nickname").style.display="inline";document.getElementById("disconnect").style.display="none";setTimeout(e,1e3)}}}function t(){w=+(new Date);var e=1+Math.ceil(A.length/4);e>A.length&&(e=A.length);for(;e--;)y.push(A.shift());for(e=0;e<y.length;e++)y[e].think()}function n(){++O;w=+(new Date);d.clearRect(0,0,h.width,h.height);var e=null!=E?E.x-100:0;g=0==g?e:Math.round((g+e)/2);for(e=-(Math.floor(g/2)%288);e<h.width;)d.drawImage(m,0,0,288,512,e,0,288,512),e+=288;d.save();d.translate(-g,0);for(e=0;e<b.length;e++)b[e].draw();d.restore();for(e=-(Math.floor(g)%336);e<h.width;)d.drawImage(m,584,0,336,111,e,401,336,111),e+=336;var t=0;d.save();d.translate(-g,0);28<=M?(_+=10,1e3<_&&(_=1e3)):(_-=10,30>_&&(_=30));for(e=0;e<y.length&&!(y[e]!=E&&y[e].draw()&&++t>_);++e);null!=E&&E.draw();d.restore();d.save();d.translate(-g,0);for(e=0;e<b.length;e++)b[e].drawOverlay();d.restore();H?d.fillText("Score: "+i()+" | Players: "+T+" | Distance: "+(null==E?0:Math.floor(E.x/200))+" | Server: "+D,20,20):d.fillText("Connecting to server "+D+"...",20,20);v.clearRect(0,0,h.width,h.height);v.drawImage(p,0,0,h.width,h.height);window.requestAnimationFrame(n)}function r(){null!=E&&(E.vx=k,E.vy=0,a(),E.reset(),N=E.x)}function i(){if(null==E)return 0;for(var e=0,t=0;t<b.length;t++)E.x>b[t].x+30&&++e;return e}function s(e,t,n){this.id=e;this.reset();this.seed=9999*Math.random();this.nick=n;this.jumps=t||[];this.playbackTime=0}function o(e,t){this.x=e;this.y=t}function u(e){var t=y.indexOf(e);-1!=t&&(e.destroy(),y.splice(t,1))}function a(){if(null!=E&&0!=E.jumps.length){var e=new ArrayBuffer(3+2*E.jumps.length),t=new DataView(e);t.setUint8(0,2);t.setUint16(1,E.jumps.length,!0);for(var n=3,r=0;r<E.jumps.length;r++)t.setUint16(n,E.jumps[r],!0),n+=2;L.send(e);E.jumps.length=0}}function l(){var e=C.value,t=new ArrayBuffer(32),n=new DataView(t);n.setUint8(0,5);for(var r=0;r<e.length&&16>r;r++){var i=e.charCodeAt(r);128<=i||n.setUint8(r+1,i)}null!=E&&(E.nick=e);clearTimeout(f);f=setTimeout(function(){L.send(t)},1e3)}function c(e,t){return e.x+e.r<t.x||e.y+e.r<t.y||e.x-e.r>t.x+t.width||e.y-e.r>t.y+t.height?!1:!0}var f=null;window.onload=function(){var i=document.getElementById("connect");i.onclick=function(){D=document.getElementById("server").value;e()};C=document.getElementById("nickname");C.onchange=l;C.onkeydown=l;C.onkeyup=l;C.onkeypress=l;document.getElementById("disconnect").onclick=function(){L.close();D=""};h=document.getElementById("canvas");v=h.getContext("2d");p=document.createElement("canvas");p.width=h.width;p.height=h.height;d=p.getContext("2d");r();t();n();setInterval(t,1e3/60)};var h,p,d,v,m=new Image;m.src="atlas.png";var g=0,y=[],b=[],w=0,E=null,S=!1,x=null,T="?",N=100,C,k=2,L,A=[],O=0,M=60,_=200,D="",P=null,H=!1;setInterval(function(){M=O;O=0},1e3);s.prototype={id:0,x:0,y:0,vx:0,vy:0,seed:0,wasSeen:!0,nick:null,jumps:null,playbackTime:0,gameOver:!1,rotation:0,targetRotation:0,removeTimer:-1,reset:function(){this.x=100;this.y=50;this.vx=k;this.vy=0;this.jumps=[];this.playbackTime=0;this.gameOver=!1;this.removeTimer=-1},draw:function(){if(-100>this.x-g||1e3<this.x-g)return!1;d.save();d.translate(2*Math.floor(this.x/2),2*Math.floor(this.y/2));var e=Math.floor((w+this.seed)/200)%2;d.rotate(this.rotation);this==E?(d.beginPath(),d.fillStyle="rgba(255, 255, 255, 0.5)",d.arc(0,0,30,0,2*Math.PI,!1),d.fill(),d.drawImage(m,230,762+52*e,34,24,-17,-12,34,24)):(d.globalAlpha*=.5,d.drawImage(m,6+56*e,982,34,24,-17,-12,34,24),d.globalAlpha/=.5);d.rotate(-this.rotation);if(e=this.nick)d.textAlign="center",d.fillStyle="#000000",d.fillText(e,1,-20),d.fillText(e,-1,-20),d.fillText(e,0,-21),d.fillText(e,0,-19),d.fillStyle="#FFFFFF",d.fillText(e,0,-20);d.restore();return!0},think:function(){++this.playbackTime;for(var e=this.gameOver,t=0;t<b.length;t++){var n=b[t];if(n.collidesWith(this)){this.gameOver=!0;break}}this.vy+=.4;389<=this.y&&(this.vy=this.vx=0,this.gameOver=!0,this==E?a():null==this.id&&u(this));this.gameOver?(this.vx=0,389<this.y&&(this.y=389),this!=E&&(0>this.removeTimer&&(this.removeTimer=Math.floor(this.x/10)),this.removeTimer-=1,0==this.removeTimer&&u(this))):this==E?S&&(this.jumps.push(this.playbackTime),S=!1,this.vy=-8):-1!=this.jumps.indexOf(this.playbackTime)&&(this.vy=-8);this.x+=this.vx;this.y+=this.vy;for(this.targetRotation=Math.atan2(this.vy,this.vx);180<this.targetRotation;)this.targetRotation-=360;for(;-180>this.targetRotation;)this.targetRotation+=360;this.rotation=(this.rotation+this.targetRotation)/2;if(!e&&this.gameOver){for(var e=null,r=0,t=0;t<b.length;t++){var n=b[t],i=Math.abs(n.x-this.x+26);100<i||!(null==e||i<r)||(r=i,e=n)}e&&++e.deaths}},setPlayback:function(e,t){this!=E&&this.reset();this.jumps=e;t&&(this.nick=t)},destroy:function(){}};o.prototype={x:0,y:0,deaths:0,getHeight:function(){return 124},draw:function(){-300>this.x-g||1200<this.x-g||(this.isValid()||(d.globalAlpha*=.5),d.drawImage(m,112,646,52,320,this.x,this.y-320,52,320),d.drawImage(m,168,646,52,320,this.x,this.y+this.getHeight(),52,320),this.isValid()||(d.globalAlpha/=.5))},drawOverlay:function(){d.save();d.translate(this.x+26,415);var e=this.deaths.toString();d.textAlign="center";d.fillStyle="#000000";d.fillText(e,1,0);d.fillText(e,-1,0);d.fillText(e,0,-1);d.fillText(e,0,1);d.fillStyle="#FFFFFF";d.fillText(e,0,0);d.restore()},collidesWith:function(e){return this.isValid()?c({x:e.x,y:e.y,r:12},{x:this.x,y:this.y-320,width:52,height:320})||c({x:e.x,y:e.y,r:12},{x:this.x,y:this.y+this.getHeight(),width:52,height:320}):!1},isValid:function(){return this.x>N+200}};document.body.onkeydown=function(e){null!=E&&E.gameOver&&389<=E.y?r():null!=E&&0<E.y&&(S=!0)};window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){setTimeout(e,1e3/60)}})()