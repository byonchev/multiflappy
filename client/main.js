(function(){function e(){g=[];w=null;P=!1;if(_.length>0){k=new WebSocket("ws://"+_);k.binaryType="arraybuffer";k.onopen=function(e){y=[];null!=w&&(T=w.x);P=!0;console.log("Socket connected");f();document.getElementById("server").style.display="none";document.getElementById("connect").style.display="none";document.getElementById("nickname").style.display="none";document.getElementById("disconnect").style.display="block"};k.onmessage=function(e){e=e.data;switch((new DataView(e)).getUint8(0)){case 0:S=(new DataView(e)).getInt32(1,!0);w=new s(S,[],N.value);g.push(w);break;case 2:e=new DataView(e);x=e.getUint32(1,!0);for(var t=e.getInt32(5,!0),n=9,r=0;r<t;r++){for(var i=e.getInt32(n,!0),n=n+4,u="";;){var a=e.getUint8(n++);if(0==a)break;u+=String.fromCharCode(a)}for(var a=[],f=e.getUint16(n,!0),n=n+2,l=0;l<f;l++)a.push(e.getUint16(n,!0)),n+=2;i!=S&&(i=new s(i,a,u),L.push(i))}break;case 3:for(e=new DataView(e),t=1,n=e.getInt32(t,!0),t+=4,r=0;r<n;r++){y.push(new o(e.getInt32(t+0,!0),e.getInt32(t+4,!0)));t+=8}}};k.onclose=function(){P=!1;document.getElementById("server").style.display="inline";document.getElementById("connect").style.display="inline";document.getElementById("nickname").style.display="inline";document.getElementById("disconnect").style.display="none";setTimeout(e,1e3)}}}function t(){b=+(new Date);var e=1+Math.ceil(L.length/4);e>L.length&&(e=L.length);for(;e--;)g.push(L.shift());for(e=0;e<g.length;e++)g[e].think()}function n(){++A;b=+(new Date);p.clearRect(0,0,c.width,c.height);var e=null!=w?w.x-100:0;m=0==m?e:Math.round((m+e)/2);for(e=-(Math.floor(m/2)%288);e<c.width;)p.drawImage(v,0,0,288,512,e,0,288,512),e+=288;p.save();p.translate(-m,0);for(e=0;e<y.length;e++)y[e].draw();p.restore();for(e=-(Math.floor(m)%336);e<c.width;)p.drawImage(v,584,0,336,111,e,401,336,111),e+=336;var t=0;p.save();p.translate(-m,0);28<=O?(M+=10,1e3<M&&(M=1e3)):(M-=10,30>M&&(M=30));for(e=0;e<g.length&&!(g[e]!=w&&g[e].draw()&&++t>M);++e);null!=w&&w.draw();p.restore();p.save();p.translate(-m,0);for(e=0;e<y.length;e++)y[e].drawOverlay();p.restore();P?p.fillText("Score: "+i()+" | Players: "+x+" | Distance: "+(null==w?0:Math.floor(w.x/200))+" | Server: "+_,20,20):p.fillText("Connecting to server "+_+"...",20,20);d.clearRect(0,0,c.width,c.height);d.drawImage(h,0,0,c.width,c.height);window.requestAnimationFrame(n)}function r(){null!=w&&(w.vx=C,w.vy=0,a(),w.reset(),T=w.x)}function i(){if(null==w)return 0;for(var e=0,t=0;t<y.length;t++)w.x>y[t].x+30&&++e;return e}function s(e,t,n){this.id=e;this.reset();this.seed=9999*Math.random();this.nick=n;this.jumps=t||[];this.playbackTime=0}function o(e,t){this.x=e;this.y=t}function u(e){var t=g.indexOf(e);-1!=t&&(e.destroy(),g.splice(t,1))}function a(){if(null!=w&&0!=w.jumps.length){var e=new ArrayBuffer(3+2*w.jumps.length),t=new DataView(e);t.setUint8(0,2);t.setUint16(1,w.jumps.length,!0);for(var n=3,r=0;r<w.jumps.length;r++)t.setUint16(n,w.jumps[r],!0),n+=2;k.send(e);w.jumps.length=0}}function f(){var e=N.value,t=new ArrayBuffer(32),n=new DataView(t);n.setUint8(0,5);for(var r=0;r<e.length&&16>r;r++){var i=e.charCodeAt(r);128<=i||n.setUint8(r+1,i)}null!=w&&(w.nick=e);k.send(t)}function l(e,t){return e.x+e.r<t.x||e.y+e.r<t.y||e.x-e.r>t.x+t.width||e.y-e.r>t.y+t.height?!1:!0}window.onload=function(){var i=document.getElementById("connect");i.onclick=function(){_=document.getElementById("server").value;e()};N=document.getElementById("nickname");N.onchange=f;N.onkeydown=f;N.onkeyup=f;N.onkeypress=f;document.getElementById("disconnect").onclick=function(){k.close();_=""};c=document.getElementById("canvas");d=c.getContext("2d");h=document.createElement("canvas");h.width=c.width;h.height=c.height;p=h.getContext("2d");r();t();n();setInterval(t,1e3/60)};var c,h,p,d,v=new Image;v.src="atlas.png";var m=0,g=[],y=[],b=0,w=null,E=!1,S=null,x="?",T=100,N,C=2,k,L=[],A=0,O=60,M=200,_="",D=null,P=!1;setInterval(function(){O=A;A=0},1e3);s.prototype={id:0,x:0,y:0,vx:0,vy:0,seed:0,wasSeen:!0,nick:null,jumps:null,playbackTime:0,gameOver:!1,rotation:0,targetRotation:0,removeTimer:-1,reset:function(){this.x=100;this.y=50;this.vx=C;this.vy=0;this.jumps=[];this.playbackTime=0;this.gameOver=!1;this.removeTimer=-1},draw:function(){if(-100>this.x-m||1e3<this.x-m)return!1;p.save();p.translate(2*Math.floor(this.x/2),2*Math.floor(this.y/2));var e=Math.floor((b+this.seed)/200)%2;p.rotate(this.rotation);this==w?(p.beginPath(),p.fillStyle="rgba(255, 255, 255, 0.5)",p.arc(0,0,30,0,2*Math.PI,!1),p.fill(),p.drawImage(v,230,762+52*e,34,24,-17,-12,34,24)):(p.globalAlpha*=.5,p.drawImage(v,6+56*e,982,34,24,-17,-12,34,24),p.globalAlpha/=.5);p.rotate(-this.rotation);if(e=this.nick)p.textAlign="center",p.fillStyle="#000000",p.fillText(e,1,-20),p.fillText(e,-1,-20),p.fillText(e,0,-21),p.fillText(e,0,-19),p.fillStyle="#FFFFFF",p.fillText(e,0,-20);p.restore();return!0},think:function(){++this.playbackTime;for(var e=this.gameOver,t=0;t<y.length;t++){var n=y[t];if(n.collidesWith(this)){this.gameOver=!0;break}}this.vy+=.4;389<=this.y&&(this.vy=this.vx=0,this.gameOver=!0,this==w?a():null==this.id&&u(this));this.gameOver?(this.vx=0,389<this.y&&(this.y=389),this!=w&&(0>this.removeTimer&&(this.removeTimer=Math.floor(this.x/10)),this.removeTimer-=1,0==this.removeTimer&&u(this))):this==w?E&&(this.jumps.push(this.playbackTime),E=!1,this.vy=-8):-1!=this.jumps.indexOf(this.playbackTime)&&(this.vy=-8);this.x+=this.vx;this.y+=this.vy;for(this.targetRotation=Math.atan2(this.vy,this.vx);180<this.targetRotation;)this.targetRotation-=360;for(;-180>this.targetRotation;)this.targetRotation+=360;this.rotation=(this.rotation+this.targetRotation)/2;if(!e&&this.gameOver){for(var e=null,r=0,t=0;t<y.length;t++){var n=y[t],i=Math.abs(n.x-this.x+26);100<i||!(null==e||i<r)||(r=i,e=n)}e&&++e.deaths}},setPlayback:function(e,t){this!=w&&this.reset();this.jumps=e;t&&(this.nick=t)},destroy:function(){}};o.prototype={x:0,y:0,deaths:0,getHeight:function(){return 124},draw:function(){-300>this.x-m||1200<this.x-m||(this.isValid()||(p.globalAlpha*=.5),p.drawImage(v,112,646,52,320,this.x,this.y-320,52,320),p.drawImage(v,168,646,52,320,this.x,this.y+this.getHeight(),52,320),this.isValid()||(p.globalAlpha/=.5))},drawOverlay:function(){p.save();p.translate(this.x+26,415);var e=this.deaths.toString();p.textAlign="center";p.fillStyle="#000000";p.fillText(e,1,0);p.fillText(e,-1,0);p.fillText(e,0,-1);p.fillText(e,0,1);p.fillStyle="#FFFFFF";p.fillText(e,0,0);p.restore()},collidesWith:function(e){return this.isValid()?l({x:e.x,y:e.y,r:12},{x:this.x,y:this.y-320,width:52,height:320})||l({x:e.x,y:e.y,r:12},{x:this.x,y:this.y+this.getHeight(),width:52,height:320}):!1},isValid:function(){return this.x>T+200}};document.body.onkeydown=function(e){null!=w&&w.gameOver&&389<=w.y?r():null!=w&&0<w.y&&(E=!0)};window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(e){setTimeout(e,1e3/60)}})()